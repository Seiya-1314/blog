(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{354:function(t,s,e){t.exports=e.p+"assets/img/module_require.e4341e4e.png"},365:function(t,s,e){"use strict";e.r(s);var a=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"node-js模块化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-js模块化","aria-hidden":"true"}},[this._v("#")]),this._v(" node.js模块化")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[this._v("#")]),this._v(" 前言")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在 "),s("code",[this._v("Node.js")]),this._v(" 模块系统中，每个文件都被视为一个独立的模块。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[e("code",[t._v("Node.js")]),t._v(" 模块机制采用了 "),e("code",[t._v("Commonjs")]),t._v(" 规范，弥补了当前 "),e("code",[t._v("JavaScript")]),t._v(" 开发大型没有标准的缺陷，类似于 "),e("code",[t._v("Java")]),t._v(" 中的类文件，"),e("code",[t._v("Python")]),t._v(" 中的 "),e("code",[t._v("import")]),t._v(" 机制，"),e("code",[t._v("NodeJs")]),t._v(" 中可以通过 "),e("code",[t._v("module.exports")]),t._v("、"),e("code",[t._v("require")]),t._v(" 来导出和引入一个模块。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在模块加载机制中，"),s("code",[this._v("NodeJs")]),this._v(" 采用了延迟加载的策略，只有在用到的情况下，系统模块才会被加载，加载完成后会放到 "),s("code",[this._v("binding_cache")]),this._v(" 中。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"模块的分类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块的分类","aria-hidden":"true"}},[this._v("#")]),this._v(" 模块的分类")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"系统模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#系统模块","aria-hidden":"true"}},[this._v("#")]),this._v(" 系统模块")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"第三方模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第三方模块","aria-hidden":"true"}},[this._v("#")]),this._v(" 第三方模块")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"模块加载机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块加载机制","aria-hidden":"true"}},[this._v("#")]),this._v(" 模块加载机制")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在Nodejs中模块加载一般会经历3个步骤，"),s("strong",[this._v("路径分析")]),this._v("、"),s("strong",[this._v("文件定位")]),this._v("、"),s("strong",[this._v("编译执行")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("p",[s("strong",[this._v("系统缓存：")])]),this._v(" "),s("p",[this._v("模块被执行之后会会进行缓存，首先是先进行缓存加载，判断缓存中是否有值。")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("p",[s("strong",[this._v("系统模块：")])]),this._v(" "),s("p",[this._v("也就是原生模块，这个优先级仅次于缓存加载，部分核心模块已经被编译成二进制，省略了路径分析、文件定位，直接加载到了内存中，系统模块定义在Node.js源码的lib目录下，可以去查看。")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("p",[s("strong",[this._v("文件模块：")])]),this._v(" "),s("p",[this._v("优先加载.、..、/开头的，如果文件没有加上扩展名，会依次按照.js、.json、.node进行扩展名补足尝试，那么在尝试的过程中也是以同步阻塞模式来判断文件是否存在，从性能优化的角度来看待，.json、.node最好还是加上文件的扩展名。")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("p",[s("strong",[this._v("目录做为模块：")])]),this._v(" "),s("p",[this._v('这种情况发生在文件模块加载过程中，也没有找到，但是发现是一个目录的情况，这个时候会将这个目录当作一个包来处理，Node这块采用了Commonjs规范，先会在项目根目录查找package.json文件，取出文件中定义的main属性("main": "lib/hello.js")描述的入口文件进行加载，也没加载到，则会抛出默认错误: Error: Cannot find module \'lib/hello.js\'')])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("p",[s("strong",[this._v("node_modules目录加载：")])]),this._v(" "),s("p",[this._v("对于系统模块、路径文件模块都找不到，Node.js会从当前模块的父目录进行查找，直到系统的根目录")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:e(354),alt:"require模块加载时序图"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"模块循环引用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块循环引用","aria-hidden":"true"}},[this._v("#")]),this._v(" 模块循环引用")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// a.js")]),t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a模块start'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nundeclaredVariable "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a模块未声明变量'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" b "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./b'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a模块加载完毕: b.test值：'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("b"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// b.js")]),t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'b模块start'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./a'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'undeclaredVariable: '")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" undeclaredVariable"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'b模块加载完毕: a.test值：'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v("a模块start\nb模块start\nundeclaredVariable:  a模块未声明变量\nb模块加载完毕: a.test值： 1\na模块加载完毕: b.test值： 2\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"答案："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#答案：","aria-hidden":"true"}},[this._v("#")]),this._v(" 答案：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("启动a.js的时候，会加载b.js，那么在b.js中又加载了a.js，但是此时a.js模块还没有执行完，返回的是一个a.js模块的exports对象未完成的副本给到b.js模块。然后b.js完成加载之后将exports对象提供给了a.js模块")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("因为undeclaredVariable是一个未声明的变量，也就是一个挂在全局的变量，那么在其他地方当然是可以拿到的。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"模块封装器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块封装器","aria-hidden":"true"}},[this._v("#")]),this._v(" 模块封装器")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("exports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" require"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __filename"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __dirname")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 模块的代码实际上在这里")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("通过这样做，"),s("code",[this._v("Node.js")]),this._v(" 实现了以下几点：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ul",[e("li",[e("p",[t._v("它保持了顶层的变量（用 "),e("code",[t._v("var")]),t._v("、 "),e("code",[t._v("const")]),t._v(" 或 "),e("code",[t._v("let")]),t._v(" 定义）作用在模块范围内，而不是全局对象。")])]),t._v(" "),e("li",[e("p",[t._v("它有助于提供一些看似全局的但实际上是模块特定的变量，例如：  - 实现者可以用于从模块中导出值的 "),e("code",[t._v("module")]),t._v(" 和 "),e("code",[t._v("exports")]),t._v(" 对象。 - 包含模块绝对文件名和目录路径的快捷变量 "),e("code",[t._v("__filename")]),t._v(" 和 "),e("code",[t._v("__dirname")]),t._v(" 。")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"exports与module-exports的区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#exports与module-exports的区别","aria-hidden":"true"}},[this._v("#")]),this._v(" exports与module.exports的区别")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("exports "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" modules"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[this._v("CommonJS定义的模块分为:")]),this._v(" "),s("p",[this._v("模块标识(module)、模块定义(exports) 、模块引用(require)")])])}],n=e(0),r=Object(n.a)({},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),t._v(" "),e("br"),t._v(" "),e("author",{attrs:{time:"2019年05月28日"}}),t._v(" "),e("br"),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),t._m(5),t._v(" "),e("br"),t._v(" "),t._m(6),t._v(" "),e("p",[t._v("C/C++模块，也叫built-in内建模块，一般用于native模块调用，在require出去")]),t._v(" "),e("p",[t._v("native模块，在开发中使用的Nodejs的http、buffer、fs等，底层也是调用的内建模块(C/C++)。")]),t._v(" "),e("br"),t._v(" "),t._m(7),t._v(" "),e("p",[t._v("这里非Nodejs自带的模块称为第三方模块，其实还分为路径形式的文件模块（以.、..、/开头的）和自定义的模块（比如express、koa框架、moment.js等）")]),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),t._m(8),t._v(" "),e("br"),t._v(" "),t._m(9),t._v(" "),e("br"),t._v(" "),e("p",[t._v("按照模块的分类，按照以下顺序进行优先加载：")]),t._v(" "),t._m(10),t._v(" "),e("br"),t._v(" "),t._m(11),t._v(" "),e("br"),t._v(" "),t._m(12),t._v(" "),e("br"),t._v(" "),t._m(13),t._v(" "),e("br"),t._v(" "),t._m(14),t._v(" "),e("br"),t._v(" "),t._m(15),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),t._m(16),t._v(" "),e("br"),t._v(" "),e("p",[t._v("看以下例子：假设有a.js、b.js两个模块相互引用，会有什么问题？是否为陷入死循环？a模块中的undeclaredVariable变量在b.js中是否会被打印？")]),t._v(" "),t._m(17),e("br"),t._v(" "),t._m(18),e("br"),t._v(" "),e("p",[t._v("最终输出结果：")]),t._v(" "),t._m(19),e("br"),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),t._m(22),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),t._m(23),t._v(" "),e("br"),t._v(" "),e("p",[t._v("在执行模块代码之前，Node.js 会使用一个如下的函数封装器将其封装：")]),t._v(" "),t._m(24),t._m(25),t._v(" "),t._m(26),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),t._m(27),t._v(" "),e("br"),t._v(" "),e("p",[t._v("在一个node执行一个文件时，会给这个文件内生成一个 exports 和 module 对象，而 module 又有一个 exports 属性。他们之间的关系如下图，都指向一块{}内存区域。如下所示:")]),t._v(" "),t._m(28),e("p",[t._v("简而言之，区分他们之间的区别就是 exports 只是 module.exports 的引用，辅助后者添加内容用的。用白话讲就是，exports只辅助 module.exports 操作内存中的数据，最后真正被 require 出去的内容还是 module.exports 的。")]),t._v(" "),e("br"),t._v(" "),t._m(29)],1)},a,!1,null,null,null);s.default=r.exports}}]);