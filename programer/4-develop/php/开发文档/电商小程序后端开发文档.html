<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>电商小程序后端开发文档 | Blog</title>
    <meta name="description" content="">
    <link rel="icon" href="/blog/icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    
    <link rel="preload" href="/blog/assets/css/0.styles.511ec017.css" as="style"><link rel="preload" href="/blog/assets/js/app.39887082.js" as="script"><link rel="preload" href="/blog/assets/js/20.e68ded11.js" as="script"><link rel="preload" href="/blog/assets/js/66.a0b0e699.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8d62a5d5.js"><link rel="prefetch" href="/blog/assets/js/100.40550fa8.js"><link rel="prefetch" href="/blog/assets/js/101.d1feb1c2.js"><link rel="prefetch" href="/blog/assets/js/102.769cf919.js"><link rel="prefetch" href="/blog/assets/js/103.de2faa5f.js"><link rel="prefetch" href="/blog/assets/js/104.a2489fe7.js"><link rel="prefetch" href="/blog/assets/js/105.dee5e421.js"><link rel="prefetch" href="/blog/assets/js/106.900b4cf4.js"><link rel="prefetch" href="/blog/assets/js/107.a3012e6e.js"><link rel="prefetch" href="/blog/assets/js/108.9168cb14.js"><link rel="prefetch" href="/blog/assets/js/109.2aae8fa4.js"><link rel="prefetch" href="/blog/assets/js/11.f516668d.js"><link rel="prefetch" href="/blog/assets/js/110.ea6bce15.js"><link rel="prefetch" href="/blog/assets/js/111.0d610899.js"><link rel="prefetch" href="/blog/assets/js/112.00965329.js"><link rel="prefetch" href="/blog/assets/js/113.9452cabc.js"><link rel="prefetch" href="/blog/assets/js/114.da288081.js"><link rel="prefetch" href="/blog/assets/js/115.992ca78d.js"><link rel="prefetch" href="/blog/assets/js/116.fc2ddb04.js"><link rel="prefetch" href="/blog/assets/js/117.3af76a15.js"><link rel="prefetch" href="/blog/assets/js/118.b22d8c65.js"><link rel="prefetch" href="/blog/assets/js/119.7fe9cbd5.js"><link rel="prefetch" href="/blog/assets/js/12.f5e2c995.js"><link rel="prefetch" href="/blog/assets/js/120.13f71485.js"><link rel="prefetch" href="/blog/assets/js/121.dabefc5a.js"><link rel="prefetch" href="/blog/assets/js/122.01a37a18.js"><link rel="prefetch" href="/blog/assets/js/123.3c5e3ba4.js"><link rel="prefetch" href="/blog/assets/js/124.f438a187.js"><link rel="prefetch" href="/blog/assets/js/125.8584f7f0.js"><link rel="prefetch" href="/blog/assets/js/126.b91c9d11.js"><link rel="prefetch" href="/blog/assets/js/127.b7d28af7.js"><link rel="prefetch" href="/blog/assets/js/128.2902b500.js"><link rel="prefetch" href="/blog/assets/js/129.af6579af.js"><link rel="prefetch" href="/blog/assets/js/13.ac13bac9.js"><link rel="prefetch" href="/blog/assets/js/130.79cf6630.js"><link rel="prefetch" href="/blog/assets/js/131.84faa2eb.js"><link rel="prefetch" href="/blog/assets/js/132.2742e7a8.js"><link rel="prefetch" href="/blog/assets/js/133.50d1603f.js"><link rel="prefetch" href="/blog/assets/js/134.eec917e9.js"><link rel="prefetch" href="/blog/assets/js/135.82e6f298.js"><link rel="prefetch" href="/blog/assets/js/136.5cdc95f2.js"><link rel="prefetch" href="/blog/assets/js/137.c57aa7c1.js"><link rel="prefetch" href="/blog/assets/js/138.03caeffa.js"><link rel="prefetch" href="/blog/assets/js/139.4c979783.js"><link rel="prefetch" href="/blog/assets/js/14.d11612a0.js"><link rel="prefetch" href="/blog/assets/js/140.49fe24b3.js"><link rel="prefetch" href="/blog/assets/js/141.f3a4768e.js"><link rel="prefetch" href="/blog/assets/js/142.b1994450.js"><link rel="prefetch" href="/blog/assets/js/143.48508e9d.js"><link rel="prefetch" href="/blog/assets/js/144.d3c779c4.js"><link rel="prefetch" href="/blog/assets/js/145.e29ed321.js"><link rel="prefetch" href="/blog/assets/js/146.0a67773b.js"><link rel="prefetch" href="/blog/assets/js/147.3724a0f3.js"><link rel="prefetch" href="/blog/assets/js/148.3abbbc37.js"><link rel="prefetch" href="/blog/assets/js/149.d733d2c8.js"><link rel="prefetch" href="/blog/assets/js/15.708d7056.js"><link rel="prefetch" href="/blog/assets/js/150.daf345ef.js"><link rel="prefetch" href="/blog/assets/js/151.a35c7ba2.js"><link rel="prefetch" href="/blog/assets/js/152.d840f8be.js"><link rel="prefetch" href="/blog/assets/js/153.05bb9ad4.js"><link rel="prefetch" href="/blog/assets/js/154.1700d777.js"><link rel="prefetch" href="/blog/assets/js/155.a9484326.js"><link rel="prefetch" href="/blog/assets/js/156.1af7a971.js"><link rel="prefetch" href="/blog/assets/js/157.b15abf15.js"><link rel="prefetch" href="/blog/assets/js/158.c643fe19.js"><link rel="prefetch" href="/blog/assets/js/159.b44de908.js"><link rel="prefetch" href="/blog/assets/js/16.2729673c.js"><link rel="prefetch" href="/blog/assets/js/160.83536c74.js"><link rel="prefetch" href="/blog/assets/js/161.9a56b076.js"><link rel="prefetch" href="/blog/assets/js/162.44cf24dd.js"><link rel="prefetch" href="/blog/assets/js/163.08ada04c.js"><link rel="prefetch" href="/blog/assets/js/164.62336204.js"><link rel="prefetch" href="/blog/assets/js/165.d312a799.js"><link rel="prefetch" href="/blog/assets/js/166.7308429c.js"><link rel="prefetch" href="/blog/assets/js/167.8d6da0df.js"><link rel="prefetch" href="/blog/assets/js/168.a47e1b46.js"><link rel="prefetch" href="/blog/assets/js/169.b624c020.js"><link rel="prefetch" href="/blog/assets/js/17.d3d6c4f8.js"><link rel="prefetch" href="/blog/assets/js/170.d47d6900.js"><link rel="prefetch" href="/blog/assets/js/171.6f9ef670.js"><link rel="prefetch" href="/blog/assets/js/172.761646f1.js"><link rel="prefetch" href="/blog/assets/js/173.eaef8eaa.js"><link rel="prefetch" href="/blog/assets/js/174.2b8425b9.js"><link rel="prefetch" href="/blog/assets/js/175.cdf21dca.js"><link rel="prefetch" href="/blog/assets/js/176.7dda6e4d.js"><link rel="prefetch" href="/blog/assets/js/177.dfed2dc8.js"><link rel="prefetch" href="/blog/assets/js/178.2a2b85a6.js"><link rel="prefetch" href="/blog/assets/js/179.0862e584.js"><link rel="prefetch" href="/blog/assets/js/18.a97ae1db.js"><link rel="prefetch" href="/blog/assets/js/180.50358b32.js"><link rel="prefetch" href="/blog/assets/js/181.0c2760a8.js"><link rel="prefetch" href="/blog/assets/js/182.86d76543.js"><link rel="prefetch" href="/blog/assets/js/183.34dc50b6.js"><link rel="prefetch" href="/blog/assets/js/184.23cc3cc8.js"><link rel="prefetch" href="/blog/assets/js/185.dde44252.js"><link rel="prefetch" href="/blog/assets/js/186.cea67f39.js"><link rel="prefetch" href="/blog/assets/js/187.db391050.js"><link rel="prefetch" href="/blog/assets/js/188.b40d981f.js"><link rel="prefetch" href="/blog/assets/js/189.b995db74.js"><link rel="prefetch" href="/blog/assets/js/19.8bf3d8ee.js"><link rel="prefetch" href="/blog/assets/js/190.f1f30722.js"><link rel="prefetch" href="/blog/assets/js/191.afec7ed4.js"><link rel="prefetch" href="/blog/assets/js/192.309ca80c.js"><link rel="prefetch" href="/blog/assets/js/193.f3997ce9.js"><link rel="prefetch" href="/blog/assets/js/194.9579f1fe.js"><link rel="prefetch" href="/blog/assets/js/195.063b2670.js"><link rel="prefetch" href="/blog/assets/js/196.a39c4829.js"><link rel="prefetch" href="/blog/assets/js/197.3f6cd84d.js"><link rel="prefetch" href="/blog/assets/js/198.3d4f8322.js"><link rel="prefetch" href="/blog/assets/js/199.6921f0c6.js"><link rel="prefetch" href="/blog/assets/js/2.710a66ec.js"><link rel="prefetch" href="/blog/assets/js/200.18db6175.js"><link rel="prefetch" href="/blog/assets/js/201.c087aa4c.js"><link rel="prefetch" href="/blog/assets/js/202.7752d54e.js"><link rel="prefetch" href="/blog/assets/js/203.a8dba60a.js"><link rel="prefetch" href="/blog/assets/js/204.e1fcdcbb.js"><link rel="prefetch" href="/blog/assets/js/205.1c5a9612.js"><link rel="prefetch" href="/blog/assets/js/206.763c3a12.js"><link rel="prefetch" href="/blog/assets/js/207.02100c3e.js"><link rel="prefetch" href="/blog/assets/js/208.77e8d0f4.js"><link rel="prefetch" href="/blog/assets/js/209.64c48380.js"><link rel="prefetch" href="/blog/assets/js/21.4d387efc.js"><link rel="prefetch" href="/blog/assets/js/210.5a8b5faa.js"><link rel="prefetch" href="/blog/assets/js/211.059ecff7.js"><link rel="prefetch" href="/blog/assets/js/212.03e7aab2.js"><link rel="prefetch" href="/blog/assets/js/213.7e47b762.js"><link rel="prefetch" href="/blog/assets/js/214.721fa60b.js"><link rel="prefetch" href="/blog/assets/js/215.6c3aa9eb.js"><link rel="prefetch" href="/blog/assets/js/216.76898a2b.js"><link rel="prefetch" href="/blog/assets/js/217.b7f85c60.js"><link rel="prefetch" href="/blog/assets/js/218.cf553201.js"><link rel="prefetch" href="/blog/assets/js/219.7da67d6c.js"><link rel="prefetch" href="/blog/assets/js/22.670c2088.js"><link rel="prefetch" href="/blog/assets/js/220.05befb7a.js"><link rel="prefetch" href="/blog/assets/js/221.dc859d5b.js"><link rel="prefetch" href="/blog/assets/js/222.14e7a92b.js"><link rel="prefetch" href="/blog/assets/js/223.afc8cad1.js"><link rel="prefetch" href="/blog/assets/js/224.46829572.js"><link rel="prefetch" href="/blog/assets/js/225.3e4a1230.js"><link rel="prefetch" href="/blog/assets/js/226.66af8b18.js"><link rel="prefetch" href="/blog/assets/js/227.c09e666e.js"><link rel="prefetch" href="/blog/assets/js/228.15b395f0.js"><link rel="prefetch" href="/blog/assets/js/229.8901c547.js"><link rel="prefetch" href="/blog/assets/js/23.13e465e1.js"><link rel="prefetch" href="/blog/assets/js/230.7fdee682.js"><link rel="prefetch" href="/blog/assets/js/231.bdb7e1d3.js"><link rel="prefetch" href="/blog/assets/js/232.b655b3b7.js"><link rel="prefetch" href="/blog/assets/js/233.12132f03.js"><link rel="prefetch" href="/blog/assets/js/234.d8de2562.js"><link rel="prefetch" href="/blog/assets/js/235.c69fb4d8.js"><link rel="prefetch" href="/blog/assets/js/236.d6287825.js"><link rel="prefetch" href="/blog/assets/js/237.30947495.js"><link rel="prefetch" href="/blog/assets/js/238.7cf936c4.js"><link rel="prefetch" href="/blog/assets/js/239.4a5db3b1.js"><link rel="prefetch" href="/blog/assets/js/24.41d599f9.js"><link rel="prefetch" href="/blog/assets/js/240.53ef9cc2.js"><link rel="prefetch" href="/blog/assets/js/241.b369e26b.js"><link rel="prefetch" href="/blog/assets/js/242.85e0aef0.js"><link rel="prefetch" href="/blog/assets/js/243.bb9261b0.js"><link rel="prefetch" href="/blog/assets/js/244.5d8cae46.js"><link rel="prefetch" href="/blog/assets/js/245.74b7721f.js"><link rel="prefetch" href="/blog/assets/js/246.7ee545e6.js"><link rel="prefetch" href="/blog/assets/js/247.88716eb3.js"><link rel="prefetch" href="/blog/assets/js/248.4e13bc0d.js"><link rel="prefetch" href="/blog/assets/js/249.62071145.js"><link rel="prefetch" href="/blog/assets/js/25.a7949d32.js"><link rel="prefetch" href="/blog/assets/js/250.457666ff.js"><link rel="prefetch" href="/blog/assets/js/251.3079434c.js"><link rel="prefetch" href="/blog/assets/js/252.e8f8da3b.js"><link rel="prefetch" href="/blog/assets/js/253.3251fdfe.js"><link rel="prefetch" href="/blog/assets/js/254.700d2743.js"><link rel="prefetch" href="/blog/assets/js/255.7b6c1da5.js"><link rel="prefetch" href="/blog/assets/js/256.18f53290.js"><link rel="prefetch" href="/blog/assets/js/257.cdc1c5e7.js"><link rel="prefetch" href="/blog/assets/js/258.bb726298.js"><link rel="prefetch" href="/blog/assets/js/259.c81a13dd.js"><link rel="prefetch" href="/blog/assets/js/26.f448418e.js"><link rel="prefetch" href="/blog/assets/js/260.41fb2180.js"><link rel="prefetch" href="/blog/assets/js/261.7a1a8351.js"><link rel="prefetch" href="/blog/assets/js/262.d599101a.js"><link rel="prefetch" href="/blog/assets/js/263.e6edd655.js"><link rel="prefetch" href="/blog/assets/js/264.be1b8dd0.js"><link rel="prefetch" href="/blog/assets/js/265.ddbb93d7.js"><link rel="prefetch" href="/blog/assets/js/266.8027398c.js"><link rel="prefetch" href="/blog/assets/js/267.6f051335.js"><link rel="prefetch" href="/blog/assets/js/268.c5988930.js"><link rel="prefetch" href="/blog/assets/js/269.6a6f353a.js"><link rel="prefetch" href="/blog/assets/js/27.cd624f4c.js"><link rel="prefetch" href="/blog/assets/js/270.544561e9.js"><link rel="prefetch" href="/blog/assets/js/271.b1561dd9.js"><link rel="prefetch" href="/blog/assets/js/272.10359eae.js"><link rel="prefetch" href="/blog/assets/js/273.b627d5cc.js"><link rel="prefetch" href="/blog/assets/js/274.74314ec3.js"><link rel="prefetch" href="/blog/assets/js/275.9521e88d.js"><link rel="prefetch" href="/blog/assets/js/276.261937a2.js"><link rel="prefetch" href="/blog/assets/js/277.297e9778.js"><link rel="prefetch" href="/blog/assets/js/278.ac64542c.js"><link rel="prefetch" href="/blog/assets/js/279.4687315d.js"><link rel="prefetch" href="/blog/assets/js/28.409853ea.js"><link rel="prefetch" href="/blog/assets/js/280.323eda42.js"><link rel="prefetch" href="/blog/assets/js/281.6e0bb75f.js"><link rel="prefetch" href="/blog/assets/js/282.c3ba3826.js"><link rel="prefetch" href="/blog/assets/js/283.38f0f832.js"><link rel="prefetch" href="/blog/assets/js/284.8f2b2d17.js"><link rel="prefetch" href="/blog/assets/js/285.5847bf94.js"><link rel="prefetch" href="/blog/assets/js/286.139526d0.js"><link rel="prefetch" href="/blog/assets/js/287.4c0b3cef.js"><link rel="prefetch" href="/blog/assets/js/288.84a1a254.js"><link rel="prefetch" href="/blog/assets/js/289.2299bf11.js"><link rel="prefetch" href="/blog/assets/js/29.b9809813.js"><link rel="prefetch" href="/blog/assets/js/290.351a1d26.js"><link rel="prefetch" href="/blog/assets/js/291.2a24c09a.js"><link rel="prefetch" href="/blog/assets/js/292.513464a3.js"><link rel="prefetch" href="/blog/assets/js/293.2137cca4.js"><link rel="prefetch" href="/blog/assets/js/294.fffdcdcc.js"><link rel="prefetch" href="/blog/assets/js/295.43bee520.js"><link rel="prefetch" href="/blog/assets/js/296.5a1110bc.js"><link rel="prefetch" href="/blog/assets/js/297.6a44973c.js"><link rel="prefetch" href="/blog/assets/js/298.c0e64037.js"><link rel="prefetch" href="/blog/assets/js/299.078804a7.js"><link rel="prefetch" href="/blog/assets/js/3.f3c7737a.js"><link rel="prefetch" href="/blog/assets/js/30.1ebcadc9.js"><link rel="prefetch" href="/blog/assets/js/300.28949535.js"><link rel="prefetch" href="/blog/assets/js/301.25dfd108.js"><link rel="prefetch" href="/blog/assets/js/302.04b54249.js"><link rel="prefetch" href="/blog/assets/js/303.f65cb3d9.js"><link rel="prefetch" href="/blog/assets/js/304.0e456f23.js"><link rel="prefetch" href="/blog/assets/js/305.632ba783.js"><link rel="prefetch" href="/blog/assets/js/306.8ec5ec6f.js"><link rel="prefetch" href="/blog/assets/js/307.5f780520.js"><link rel="prefetch" href="/blog/assets/js/308.496a7426.js"><link rel="prefetch" href="/blog/assets/js/309.5340f2bf.js"><link rel="prefetch" href="/blog/assets/js/31.357acc50.js"><link rel="prefetch" href="/blog/assets/js/310.75448bbe.js"><link rel="prefetch" href="/blog/assets/js/311.8e69405c.js"><link rel="prefetch" href="/blog/assets/js/312.a2f9a614.js"><link rel="prefetch" href="/blog/assets/js/313.911e5817.js"><link rel="prefetch" href="/blog/assets/js/314.37b7ac1d.js"><link rel="prefetch" href="/blog/assets/js/315.ecb8c705.js"><link rel="prefetch" href="/blog/assets/js/316.a226cace.js"><link rel="prefetch" href="/blog/assets/js/317.9d29f704.js"><link rel="prefetch" href="/blog/assets/js/318.eeea8523.js"><link rel="prefetch" href="/blog/assets/js/319.9e692cb6.js"><link rel="prefetch" href="/blog/assets/js/32.2883af47.js"><link rel="prefetch" href="/blog/assets/js/320.1a4314f8.js"><link rel="prefetch" href="/blog/assets/js/321.6cee257b.js"><link rel="prefetch" href="/blog/assets/js/322.4ed153a9.js"><link rel="prefetch" href="/blog/assets/js/323.d08b22df.js"><link rel="prefetch" href="/blog/assets/js/324.543cc5d3.js"><link rel="prefetch" href="/blog/assets/js/325.3b689f75.js"><link rel="prefetch" href="/blog/assets/js/33.8a991593.js"><link rel="prefetch" href="/blog/assets/js/34.8f405b18.js"><link rel="prefetch" href="/blog/assets/js/35.85dc6ad0.js"><link rel="prefetch" href="/blog/assets/js/36.334d2820.js"><link rel="prefetch" href="/blog/assets/js/37.5635d66f.js"><link rel="prefetch" href="/blog/assets/js/38.da422504.js"><link rel="prefetch" href="/blog/assets/js/39.9065fb1f.js"><link rel="prefetch" href="/blog/assets/js/4.bd663a0f.js"><link rel="prefetch" href="/blog/assets/js/40.49a38102.js"><link rel="prefetch" href="/blog/assets/js/41.99219a8a.js"><link rel="prefetch" href="/blog/assets/js/42.9deba258.js"><link rel="prefetch" href="/blog/assets/js/43.bf3d34cc.js"><link rel="prefetch" href="/blog/assets/js/44.3f32996e.js"><link rel="prefetch" href="/blog/assets/js/45.d4a55e74.js"><link rel="prefetch" href="/blog/assets/js/46.05a08a80.js"><link rel="prefetch" href="/blog/assets/js/47.3e38598b.js"><link rel="prefetch" href="/blog/assets/js/48.2e9c3ea6.js"><link rel="prefetch" href="/blog/assets/js/49.1ca1c005.js"><link rel="prefetch" href="/blog/assets/js/5.c93f43b0.js"><link rel="prefetch" href="/blog/assets/js/50.4d3f00c1.js"><link rel="prefetch" href="/blog/assets/js/51.ea8551e8.js"><link rel="prefetch" href="/blog/assets/js/52.ad927f49.js"><link rel="prefetch" href="/blog/assets/js/53.e2a3e703.js"><link rel="prefetch" href="/blog/assets/js/54.5aa22d0d.js"><link rel="prefetch" href="/blog/assets/js/55.c2bad324.js"><link rel="prefetch" href="/blog/assets/js/56.8422a5c9.js"><link rel="prefetch" href="/blog/assets/js/57.bdd58bd7.js"><link rel="prefetch" href="/blog/assets/js/58.ee0a9517.js"><link rel="prefetch" href="/blog/assets/js/59.2af462a1.js"><link rel="prefetch" href="/blog/assets/js/6.b94078ac.js"><link rel="prefetch" href="/blog/assets/js/60.e885ba72.js"><link rel="prefetch" href="/blog/assets/js/61.c08b05f1.js"><link rel="prefetch" href="/blog/assets/js/62.ba3452ac.js"><link rel="prefetch" href="/blog/assets/js/63.bce62af9.js"><link rel="prefetch" href="/blog/assets/js/64.0bef7045.js"><link rel="prefetch" href="/blog/assets/js/65.66e6654e.js"><link rel="prefetch" href="/blog/assets/js/67.c18a5ac3.js"><link rel="prefetch" href="/blog/assets/js/68.ea9cef57.js"><link rel="prefetch" href="/blog/assets/js/69.2021cec2.js"><link rel="prefetch" href="/blog/assets/js/7.21125540.js"><link rel="prefetch" href="/blog/assets/js/70.8cd6664b.js"><link rel="prefetch" href="/blog/assets/js/71.0fc7d28a.js"><link rel="prefetch" href="/blog/assets/js/72.98471ee3.js"><link rel="prefetch" href="/blog/assets/js/73.e5fe0c76.js"><link rel="prefetch" href="/blog/assets/js/74.6b6cd52a.js"><link rel="prefetch" href="/blog/assets/js/75.5dd021dd.js"><link rel="prefetch" href="/blog/assets/js/76.1b7c78e8.js"><link rel="prefetch" href="/blog/assets/js/77.40a0eb4d.js"><link rel="prefetch" href="/blog/assets/js/78.bdeac015.js"><link rel="prefetch" href="/blog/assets/js/79.3db1f22a.js"><link rel="prefetch" href="/blog/assets/js/8.f792d71f.js"><link rel="prefetch" href="/blog/assets/js/80.a0c1c191.js"><link rel="prefetch" href="/blog/assets/js/81.73fb109d.js"><link rel="prefetch" href="/blog/assets/js/82.02279f28.js"><link rel="prefetch" href="/blog/assets/js/83.066e0728.js"><link rel="prefetch" href="/blog/assets/js/84.1896275c.js"><link rel="prefetch" href="/blog/assets/js/85.f933720e.js"><link rel="prefetch" href="/blog/assets/js/86.ac14e7ba.js"><link rel="prefetch" href="/blog/assets/js/87.a7f98f52.js"><link rel="prefetch" href="/blog/assets/js/88.1b80b23b.js"><link rel="prefetch" href="/blog/assets/js/89.e349b1a9.js"><link rel="prefetch" href="/blog/assets/js/9.67dfc6fe.js"><link rel="prefetch" href="/blog/assets/js/90.5cb0f91e.js"><link rel="prefetch" href="/blog/assets/js/91.edb5ce05.js"><link rel="prefetch" href="/blog/assets/js/92.ed3339a0.js"><link rel="prefetch" href="/blog/assets/js/93.0d22df77.js"><link rel="prefetch" href="/blog/assets/js/94.38c2a576.js"><link rel="prefetch" href="/blog/assets/js/95.99ccbc44.js"><link rel="prefetch" href="/blog/assets/js/96.c15116f1.js"><link rel="prefetch" href="/blog/assets/js/97.6cc50155.js"><link rel="prefetch" href="/blog/assets/js/98.3137c72a.js"><link rel="prefetch" href="/blog/assets/js/99.fa91accf.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.511ec017.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">读书</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/book/read/" class="nav-link">记录</a></li><li class="dropdown-item"><!----> <a href="/blog/book/notes/" class="nav-link">笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/1-basic/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/browser/" class="nav-link">浏览器</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/system/" class="nav-link">操作系统</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/network/" class="nav-link">计算机网络</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/organization/" class="nav-link">计算机组成原理</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/2-frame/vue.js/" class="nav-link">Vue.js</a></li><li class="dropdown-subitem"><a href="/blog/programer/2-frame/mini-app/" class="nav-link">小程序</a></li></ul></li><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/3-tool/shell/" class="nav-link">shell</a></li><li class="dropdown-subitem"><a href="/blog/programer/3-tool/webpack/" class="nav-link">webpack</a></li><li class="dropdown-subitem"><a href="/blog/programer/3-tool/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>后端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/4-develop/php/" class="nav-link router-link-active">php</a></li><li class="dropdown-subitem"><a href="/blog/programer/4-develop/node.js/" class="nav-link">node.js</a></li></ul></li><li class="dropdown-item"><h4>其它</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/5-standard/standard/" class="nav-link">编码规范</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>经济学</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/economics/" class="nav-link">薛兆丰的经济学课</a></li></ul></li><li class="dropdown-item"><h4>统计学</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/statistics/描述统计学/" class="nav-link">描述统计学</a></li><li class="dropdown-subitem"><a href="/blog/hobby/statistics/统计学习方法/" class="nav-link">统计学习方法</a></li></ul></li><li class="dropdown-item"><h4>产品思维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/product/梁宁产品思维三十讲/" class="nav-link">梁宁产品思维三十讲</a></li><li class="dropdown-subitem"><a href="/blog/hobby/product/梁宁增长思维三十讲/" class="nav-link">梁宁增长思维三十讲</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/Seiya-1314" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">读书</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/book/read/" class="nav-link">记录</a></li><li class="dropdown-item"><!----> <a href="/blog/book/notes/" class="nav-link">笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/1-basic/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/browser/" class="nav-link">浏览器</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/system/" class="nav-link">操作系统</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/network/" class="nav-link">计算机网络</a></li><li class="dropdown-subitem"><a href="/blog/programer/1-basic/organization/" class="nav-link">计算机组成原理</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/2-frame/vue.js/" class="nav-link">Vue.js</a></li><li class="dropdown-subitem"><a href="/blog/programer/2-frame/mini-app/" class="nav-link">小程序</a></li></ul></li><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/3-tool/shell/" class="nav-link">shell</a></li><li class="dropdown-subitem"><a href="/blog/programer/3-tool/webpack/" class="nav-link">webpack</a></li><li class="dropdown-subitem"><a href="/blog/programer/3-tool/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>后端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/4-develop/php/" class="nav-link router-link-active">php</a></li><li class="dropdown-subitem"><a href="/blog/programer/4-develop/node.js/" class="nav-link">node.js</a></li></ul></li><li class="dropdown-item"><h4>其它</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/programer/5-standard/standard/" class="nav-link">编码规范</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>经济学</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/economics/" class="nav-link">薛兆丰的经济学课</a></li></ul></li><li class="dropdown-item"><h4>统计学</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/statistics/描述统计学/" class="nav-link">描述统计学</a></li><li class="dropdown-subitem"><a href="/blog/hobby/statistics/统计学习方法/" class="nav-link">统计学习方法</a></li></ul></li><li class="dropdown-item"><h4>产品思维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/hobby/product/梁宁产品思维三十讲/" class="nav-link">梁宁产品思维三十讲</a></li><li class="dropdown-subitem"><a href="/blog/hobby/product/梁宁增长思维三十讲/" class="nav-link">梁宁增长思维三十讲</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/Seiya-1314" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>电商小程序后端开发文档</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#项目介绍" class="sidebar-link">项目介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#技术栈" class="sidebar-link">技术栈</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#项目目录结构" class="sidebar-link">项目目录结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#项目开发总结" class="sidebar-link">项目开发总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#restful-api实践" class="sidebar-link">RESTFul API实践</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#aop思想实践" class="sidebar-link">AOP思想实践</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#orm思想实践" class="sidebar-link">ORM思想实践</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#参数校验" class="sidebar-link">参数校验</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#参数过滤" class="sidebar-link">参数过滤</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#全局异常处理" class="sidebar-link">全局异常处理</a></li></ul></li><li><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#业务开发细节" class="sidebar-link">业务开发细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#生成-token-令牌" class="sidebar-link">生成 Token 令牌</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#校验-token-令牌" class="sidebar-link">校验 Token 令牌</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#用户身份权限控制" class="sidebar-link">用户身份权限控制</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#微信支付" class="sidebar-link">微信支付</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#订单系统" class="sidebar-link">订单系统</a></li><li class="sidebar-sub-header"><a href="/blog/programer/4-develop/php/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E7%94%B5%E5%95%86%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.html#分页" class="sidebar-link">分页</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="电商小程序后端开发文档"><a href="#电商小程序后端开发文档" aria-hidden="true" class="header-anchor">#</a> 电商小程序后端开发文档</h1> <br> <div><p><font color="gray">作者：Seiya</font></p> <p><font color="gray">时间：2019年05月11日</font></p> <!----></div> <br> <h2 id="项目介绍"><a href="#项目介绍" aria-hidden="true" class="header-anchor">#</a> 项目介绍</h2> <p>这不是一个真实的项目，只是自己在进行PHP后端开发学习过程中的一次实战练习，目的是了解一些后端开发时的思路，熟悉ThinkPHP框架在实际开发过程中的一些应用。同时记录下自己的开发历程、开发过程中的思路以及一些功能的实现细节，便于自己后续进行回顾。</p> <br> <br> <h2 id="技术栈"><a href="#技术栈" aria-hidden="true" class="header-anchor">#</a> 技术栈</h2> <ul><li><p><code>ThinkPHP</code>：快速、简单的面向对象的轻量级PHP开发框架</p></li> <li><p><code>MySQL</code>：一个关系型数据库管理系统</p></li> <li><p><code>Apache2</code>：Web服务器软件</p></li></ul> <br> <br> <h2 id="项目目录结构"><a href="#项目目录结构" aria-hidden="true" class="header-anchor">#</a> 项目目录结构</h2> <div class="language- extra-class"><pre class="language-text"><code>.
├── application                             # 应用目录
│   ├── api                                 # 模块目录
│   │   ├── behavior
│   │   ├── common.php                      # 模块公共函数文件
│   │   ├── config.php                      # 模块配置文件
│   │   ├── controller                      # 控制器层目录
│   │   ├── service                         # 应用服务层目录
│   │   ├── model                           # 模型层目录
│   │   └── validate                        # 校验层目录
│   ├── lib                                 # 自定义类库目录
│   │   ├── enum
│   │   │   ├── OrderStatusEnum.php
│   │   │   └── ScopeEnum.php
│   │   └── exception                       # 全局异常定义目录
│   ├── extra                               # 应用扩展配置文件
│   ├── route.php                           # 路由配置文件
│   ├── command.php                         # 命令行定义文件
│   ├── common.php                          # 应用公共函数文件
│   ├── config.php                          # 应用配置文件
│   ├── database.php                        # 数据库配置文件
│   └── test
│       ├── common.php
│       ├── config.php
│       ├── controller
│       └── model
├── build.php                               # 自动生成定义文件
├── extend                                  # 扩展类库目录
│   ├── Firebase                            #
│   │   └── JWT
│   ├── ItsDangerous
│   │   ├── BadData
│   │   ├── Signer
│   │   └── Support
│   └── WxPay                               # 微信支付扩展
├── log                                     # 应用日志目录
├── public                                  # WEB目录（对外访问目录）
├── think                                   # 命令行入口文件
├── thinkphp                                # 框架系统目录
└── vendor                                  # 第三方类库目录（Composer依赖库）
</code></pre></div><br> <br> <h2 id="项目开发总结"><a href="#项目开发总结" aria-hidden="true" class="header-anchor">#</a> 项目开发总结</h2> <br> <h3 id="restful-api实践"><a href="#restful-api实践" aria-hidden="true" class="header-anchor">#</a> RESTFul API实践</h3> <p>REST全称是Representational State Transfer，中文意思是表述性状态转移。它是一种互联网应用程序的API设计理念：URL定位资源，用HTTP动词（GET,POST,DELETE,DETC）描述操作。</p> <br> <ul><li><p><strong>参考学习资料</strong></p> <ul><li><p><a href="https://developers.douban.com/wiki/?title=api_v2" target="_blank" rel="noopener noreferrer">豆瓣开放API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（目前已关闭）</p></li> <li><p><a href="https://developer.github.com/v4/" target="_blank" rel="noopener noreferrer">Github开放API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></li></ul> <br> <ul><li><p><strong>扩展阅读</strong></p> <ul><li><p><a href="http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html" target="_blank" rel="noopener noreferrer">阮一峰 - RESTful API最佳实践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://www.ruanyifeng.com/blog/2018/12/async-api-design.html" target="_blank" rel="noopener noreferrer">阮一峰 - 异步 API 的设计<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.runoob.com/w3cnote/restful-architecture.html" target="_blank" rel="noopener noreferrer">菜鸟教程 - RESTful 架构详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></li></ul> <br> <ul><li><p><strong>五种 <code>HTTP</code> 方法，对应 <code>CRUD</code> 操作</strong></p> <div class="language- extra-class"><pre class="language-text"><code>GET：读取（Read）

POST：新建（Create）

PUT：更新（Update）

PATCH：更新（Update），通常是部分更新

DELETE：删除（Delete）
</code></pre></div></li></ul> <br> <ul><li><p><strong>实际应用举例：</strong></p> <div class="language-php extra-class"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'api/:version/theme'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'api/:version.Theme/getThemeList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/:id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'api/:version.Theme/getComplexOne'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">':theme_id/product/:product_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'api/:version.Theme/addThemeProduct'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token single-quoted-string string">':theme_id/product/:product_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'api/:version.Theme/deleteThemeProduct'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <br> <br> <h3 id="aop思想实践"><a href="#aop思想实践" aria-hidden="true" class="header-anchor">#</a> AOP思想实践</h3> <p>AOP为Aspect Oriented Programming的缩写，意为：面向切面编程，通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。</p> <br> <ul><li><p><strong>扩展阅读</strong></p> <ul><li><p><a href="https://juejin.im/post/5b06bf2df265da0de2574ee1" target="_blank" rel="noopener noreferrer">掘金 - Spring AOP就是这么简单啦<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://juejin.im/post/5aa7818af265da23844040c6" target="_blank" rel="noopener noreferrer">掘金 - 一起来谈谈 Spring AOP！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://juejin.im/post/5bbff7daf265da0aef4e330c" target="_blank" rel="noopener noreferrer">掘金 - 面试问烂的 Spring AOP 原理、SpringMVC 过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://blog.csdn.net/github_34889651/article/details/51321499" target="_blank" rel="noopener noreferrer">《Spring 实战》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></li></ul> <br> <ul><li><p><strong>实际应用举例：</strong></p> <p>先来看看在实际开发过程中遇到的问题：</p> <p><img src="data:image/png;base64,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" alt></p> <p>可以看到这些业务逻辑(开始、结束、提交事务)依附在业务类的方法逻辑中！</p> <p><img src="/blog/assets/img/kaifa_2.37a9c7f9.png" alt></p> <p>上面的图也很清晰了，将重复性的逻辑代码横切出来其实很容易(我们简单可认为就是封装成一个类就好了)，但我们要将这些被我们横切出来的逻辑代码融合到业务逻辑中，来完成和之前(没抽取前)一样的功能！这就是AOP首要解决的问题了！</p> <br> <p>像下面总结的“全局异常处理”和“参数校验处理”就是AOP思想的典型应用，如下：</p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 参数验证处理</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsMustBeInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 业务代码</span>
        <span class="token variable">$banner</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 全局异常处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$banner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BannerMissException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 返回最终结果</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">解释：</p> <p>上面这个案例就是AOP思想的典型应用，本质上就是将分散在业务逻辑代码中相同的代码通过切割的方式抽取到一个独立的模块中！</p></div></li></ul> <br> <br> <h3 id="orm思想实践"><a href="#orm思想实践" aria-hidden="true" class="header-anchor">#</a> ORM思想实践</h3> <p>简单说，ORM就是通过实例对象的语法，完成关系型数据库的操作的技术，是&quot;对象-关系映射&quot;（Object/Relational Mapping） 的缩写。</p> <div class="tip custom-block"><p class="custom-block-title">ORM把数据库映射成对象：</p> <ul><li><p>数据库的表（table） --&gt; 类（class）</p></li> <li><p>记录（record，行数据）--&gt; 对象（object）</p></li> <li><p>字段（field）--&gt; 对象的属性（attribute）</p></li></ul></div> <br> <ul><li><p><strong>扩展阅读</strong></p> <ul><li><a href="http://www.ruanyifeng.com/blog/2019/02/orm-tutorial.html" target="_blank" rel="noopener noreferrer">阮一峰 - ORM实例教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <br> <ul><li><p><strong>实际应用举例：</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * Product类自动映射数据库中的Product表（注意类名和表名保持一致）
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span> <span class="token punctuation">{</span>
    <span class="token comment">// ThinkPHP框架自带的操作（自动更新datetime时间戳）</span>
    <span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'datetime'</span><span class="token punctuation">;</span>

    <span class="token comment">// 手动关联数据库表</span>
    <span class="token comment">// protected $table = 'product';</span>

    <span class="token comment">// 自定义返回Json数据中需要隐藏的字段</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'delete_time'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'main_img_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'pivot'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'from'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'category_id'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'create_time'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'update_time'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义关联关系（Product表和ProductImage表为一对多的关系）</span>
    <span class="token comment">// ProductImage是关联模型名，product_id是关联模型外键，id是当前模型关联主键</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">imgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ProductImage'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'product_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 自动拼接图片url地址</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getMainImgUrlAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prefixImgUrl</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 数据库操作</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getProductDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$product</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'imgs'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'imgUrl'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'order'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'asc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'properties'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$product</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 ORM 使用对象封装了数据库操作，因此可以不碰 SQL 语言。开发者只使用面向对象编程，与数据对象直接交互，不用关心底层数据库。</p></li></ul> <br> <br> <h3 id="参数校验"><a href="#参数校验" aria-hidden="true" class="header-anchor">#</a> 参数校验</h3> <p>一个应用的输入应该首先要验证，在一个Web应用中，验证通常要实现2次：第一次是客户端验证，第二次是服务端验证。客户端的验证是为了更好的用户体验，通过检测表单的字段来提醒用户必须的字段；服务端的验证是更严格且无法避免的。</p> <p>构建参数校验层也可以方便对项目进行解耦，这样扩展性更好，同时隐藏更多的实现细节，不用暴露更多的数据。</p> <br> <ul><li><p><strong>构建校验类的基类</strong></p> <p>所有的校验类都从基类中继承了 <code>goCheck</code> 函数，便于子类进行复用（如果有更多使用频率高的自定义校验函数，都可以放在基类里面）。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
* 验证类的基类
*/</span>
<span class="token keyword">class</span> <span class="token class-name">BaseValidate</span> <span class="token keyword">extends</span> <span class="token class-name">Validate</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
    * 检测所有客户端发来的参数是否符合验证类规则
    * 基类定义了很多自定义验证方法，这些自定义验证方法其实，也可以直接调用
    * @throws ParameterException
    * @return true
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> Request<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 抛出自定义参数异常</span>
            <span class="token variable">$exception</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'msg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">';'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token variable">$exception</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>构建校验类的子类</strong></p> <p>根据业务来构建参数的校验方式，比如：正整数校验、参数范围校验、Token校验、分页校验、字符长度校验、是否为空校验等等，这里只记录两种校验方式，如下：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
* 正整数校验
*/</span>
<span class="token keyword">class</span> <span class="token class-name">IDMustBeInt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseValidate</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 校验规则</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'require|isInteger'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 自定义异常msg</span>
    <span class="token keyword">protected</span> <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'ids'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'ids参数必须为以逗号分隔的多个正整数'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 自定义校验方法（这个函数应该放在基类中）</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">isInteger</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$rule</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$field</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_int</span><span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
* 分页校验
*/</span>
<span class="token keyword">class</span> <span class="token class-name">PageParameter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseValidate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'page'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'isInteger'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'size'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'isInteger'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'page'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'分页参数必须是正整数'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'size'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'分页参数必须是正整数'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>使用校验层</strong></p> <p>根据业务判断接口调用是否需要进行参数校验，以及参数校验的类型。具体调用方式如下：</p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-php"><code><span class="token comment">/**
 * controller层中调用参数校验
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 参数验证</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsMustBeInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$banner</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$banner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BannerMissException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <br> <h3 id="参数过滤"><a href="#参数过滤" aria-hidden="true" class="header-anchor">#</a> 参数过滤</h3> <p>用户输入校验之后，还需要对传送到后端的参数进行过滤。所以，前端必须依据约定的字段名进行提交，同时也能够避免应用一些安全性方面的漏洞。</p> <br> <ul><li><p><strong>具体实现</strong></p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-php"><code><span class="token comment">/**
 * @param array $arrays 通常传入request.post变量数组
 * @return array 按照规则key过滤后的变量数组
 * @throws ParameterException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getDataByRule</span><span class="token punctuation">(</span><span class="token variable">$arrays</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 过滤user_id或者uid，防止恶意覆盖user_id外键</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">,</span> <span class="token variable">$arrays</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'uid'</span><span class="token punctuation">,</span> <span class="token variable">$arrays</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'msg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'参数中包含有非法的参数名user_id或者uid'</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$newArray</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 过滤参数</span>
    <span class="token comment">// 后端仅依据约定的key值获取参数</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">rule</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$newArray</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arrays</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$newArray</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <h3 id="全局异常处理"><a href="#全局异常处理" aria-hidden="true" class="header-anchor">#</a> 全局异常处理</h3> <p>在项目的开发中，不管是对底层的数据库操作过程，还是业务层的处理过程，还是控制层的处理过程，都不可避免会遇到各种可预知的、不可预知的异常需要处理。每个过程都单独处理异常，系统的代码耦合度高，工作量大且不好统一，维护的工作量也很大。为了解决这个问题，可以将所有类型的异常处理从各处理过程解耦出来，这样既保证了相关处理过程的功能较单一，也实现了异常信息的统一处理和维护。</p> <br> <ul><li><p><strong>自定义异常类型</strong></p> <p>在进行全局异常处理的编写前，需要对整个业务中可能的异常进行梳理，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>999 未知错误

1 开头为通用错误
2 商品类错误
3 主题类错误
4 Banner类错误
5 类目类错误
6 用户类错误
8 订单类错误

10000 通用参数错误
10001 资源未找到
10002 未授权（令牌不合法）
10003 尝试非法操作（自己的令牌操作其他人数据）
10004 授权失败（第三方应用账号登陆失败）
10005 授权失败（服务器缓存异常）

20000 请求商品不存在
30000 请求主题不存在
40000 Banner不存在
50000 类目不存在
60000 用户不存在
60001 用户地址不存在

80000 订单不存在
80001 订单中的商品不存在，可能已被删除
80002 订单还未支付，却尝试发货
80003 订单已支付过
</code></pre></div></li></ul> <br> <ul><li><p><strong>重写 <code>Handle类</code> 的 render 方法，实现自定义异常消息</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">ExceptionHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handle</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$msg</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$errorCode</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">BaseException</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//如果是自定义异常，则控制http状态码，不记录日志（通常是客户端传递参数错误或者用户请求造成的异常）</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">msg</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">errorCode</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">errorCode</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">// 如果是服务器未处理的异常，将http状态码设置为500，并记录日志</span>
            <span class="token comment">// 调试状态下显示ThinkPHP默认异常页面</span>
            <span class="token comment">// 生产环境下记录错误日志</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'app_debug'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'sorry，we make a mistake. (^o^)Y'</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">errorCode</span> <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">recordErrorLog</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$request</span> <span class="token operator">=</span> Request<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'msg'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">msg</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'error_code'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">errorCode</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'request_url'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * 将异常写入日志
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">recordErrorLog</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'type'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token single-quoted-string string">'File'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'path'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token constant">LOG_PATH</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'level'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'error'</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>自定义异常类型基类</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">BaseException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>             <span class="token comment">// HTTP状态码 404、200...</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'参数错误'</span><span class="token punctuation">;</span>        <span class="token comment">// 错误具体信息</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>      <span class="token comment">// 自定义错误码</span>

    <span class="token comment">/**
     * 构造函数，接收一个关联数组
     * @param array $params 关联数组只应包含code、msg和errorCode，且不应该是空值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$param</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$param</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token variable">$param</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">errorCode</span> <span class="token operator">=</span> <span class="token variable">$param</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'errorCode'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>构建异常处理类型子类</strong></p> <p>异常处理有很多类型，同时根据业务不同会有不同的异常，需要单独进行构建，比如：参数异常、数据库异常、Token异常、业务异常等等...</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 404时抛出此异常
 */</span>
<span class="token keyword">class</span> <span class="token class-name">MissException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'global:your required resource are not found'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * token验证失败时抛出此异常
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ForbiddenException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">403</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'权限不够'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 通用参数类异常错误
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ParameterException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;invalid parameters&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">OrderException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'订单不存在，请检查ID'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">80000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>调用异常处理</strong></p> <p>根据具体情况判断需要调用的异常类型。具体调用方式如下：</p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-php"><code><span class="token comment">/**
 * 业务异常类型处理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsMustBeInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$banner</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$banner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若返回的$banner为空，抛出异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BannerMissException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-php"><code><span class="token comment">/**
 * 参数异常类型处理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">BaseValidate</span> <span class="token keyword">extends</span> <span class="token class-name">Validate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> Request<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 抛出自定义参数异常</span>
            <span class="token variable">$exception</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'msg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">';'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">error</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token variable">$exception</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <br> <h2 id="业务开发细节"><a href="#业务开发细节" aria-hidden="true" class="header-anchor">#</a> 业务开发细节</h2> <br> <h3 id="生成-token-令牌"><a href="#生成-token-令牌" aria-hidden="true" class="header-anchor">#</a> 生成 Token 令牌</h3> <p>整体 token 身份体系如下图所示：</p> <p><img src="/blog/assets/img/kaifa_3.92ea6798.png" alt></p> <ul><li><p><strong>Controller层</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 用户获取令牌（登陆）
 * @url /token
 * @POST code
 * @note 虽然查询应该使用get，但为了稍微增强安全性，所以使用POST
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 参数校验</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TokenGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$wx</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserToken</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$wx</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'token'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$token</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>Service层</strong></p> <p>由于登录逻辑相当复杂，所以增加了 Service 层，用于封装复杂的业务逻辑，如果业务逻辑比较简单，可以直接通过 Model 层实现。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">UserToken</span> <span class="token keyword">extends</span> <span class="token class-name">Token</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxLoginUrl</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppID</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppSecret</span><span class="token punctuation">;</span>

    <span class="token comment">// 接收 code 拼接成 loginurl</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxAppID</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wx.app_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxAppSecret</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wx.app_secret'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxLoginUrl</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>
            <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wx.login_url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxAppID</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxAppSecret</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 登陆
    * 思路1：每次调用登录接口都去微信刷新一次session_key，生成新的Token，不删除久的Token
    * 思路2：检查Token有没有过期，没有过期则直接返回当前Token
    * 思路3：重新去微信刷新session_key并删除当前Token，返回新的Token
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 向微信服务器发送 http 请求</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wxLoginUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注意json_decode的第一个参数true</span>
        <span class="token comment">// 这将使字符串被转化为数组而非对象</span>
        <span class="token variable">$wxResult</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 微信返回结果判断（这里有两层）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 空值异常判断</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'获取session_key及openID时异常，微信内部错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 建议用明确的变量来表示是否成功</span>
            <span class="token comment">// 微信服务器并不会将错误标记为400，无论成功还是失败都标记成200</span>
            <span class="token comment">// 这样非常不好判断，只能使用errcode是否存在来判断</span>
            <span class="token variable">$loginFail</span> <span class="token operator">=</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'errcode'</span><span class="token punctuation">,</span> <span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$loginFail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 抛出异常，返回给客户端</span>
                <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">processLoginError</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 验证成功则颁发令牌</span>
                <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 颁发令牌</span>
    <span class="token comment">// 只要调用登陆就颁发新令牌，但旧的令牌依然可以使用</span>
    <span class="token comment">// 所以通常令牌的有效时间比较短，目前微信的express_in时间是7200秒</span>
    <span class="token comment">// 在不设置刷新令牌（refresh_token）的情况下，只能延迟自有token的过期时间超过7200秒</span>
    <span class="token comment">// 目前还无法确定，在express_in时间到期后，还能否进行微信支付</span>
    <span class="token comment">// 没有刷新令牌会有一个问题，就是用户的操作有可能会被突然中断</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 此处生成令牌使用的是TP5自带的令牌</span>
        <span class="token comment">// 如果想要更加安全可以考虑自己生成更复杂的令牌</span>
        <span class="token comment">// 比如使用JWT并加入盐，如果不加入盐有一定的几率伪造令牌</span>
        <span class="token comment">// $token = Request::instance()-&gt;token('token', 'md5');</span>
        <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'openid'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 查看数据库openID是否已存在</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getByOpenID</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 借助微信的openid作为用户标识，但在系统中的相关查询还是使用自己的uid</span>
            <span class="token comment">// 创建新用户</span>
            <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">newUser</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将微信返回结果和内部的 userID 拼接成 value 值</span>
        <span class="token variable">$cachedValue</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prepareCachedValue</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">saveToCache</span><span class="token punctuation">(</span><span class="token variable">$cachedValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 由于性能考虑，将 value 写入缓存，而不是数据库</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">saveToCache</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$key</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$expire_in</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'setting.token_expire_in'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将数据写入缓存</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$expire_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'msg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'服务器缓存异常'</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'errorCode'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">10005</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成 token 令牌</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 随机生成一个32位的字符串（若不考虑安全问题，可直接返回此字符串表示 token）</span>
        <span class="token variable">$randChar</span> <span class="token operator">=</span> <span class="token function">getRandChar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当前时间戳</span>
        <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'REQUEST_TIME_FLOAT'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 取出内部定义的 salt 配置</span>
        <span class="token variable">$tokenSalt</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'secure.token_salt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 用三组字符串进行 md5 加密</span>
        <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$randChar</span> <span class="token punctuation">.</span> <span class="token variable">$timestamp</span> <span class="token punctuation">.</span> <span class="token variable">$tokenSalt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 随机拼接一个32位字符串</span>
    <span class="token keyword">function</span> <span class="token function">getRandChar</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
        <span class="token variable">$strPol</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$max</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$strPol</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$str</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$strPol</span><span class="token punctuation">[</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$max</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>Model层</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token comment">//    protected $createTime = ;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Order'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasOne</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UserAddress'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 用户是否存在
    * 存在返回uid，不存在返回0
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getByOpenID</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'openid'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'='</span><span class="token punctuation">,</span> <span class="token variable">$openid</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <br> <h3 id="校验-token-令牌"><a href="#校验-token-令牌" aria-hidden="true" class="header-anchor">#</a> 校验 Token 令牌</h3> <p>当用户访问受保护的接口时，必须要传入 token 令牌。服务端拿到 token 令牌后，需要验证 token 是否合法，若 token 合法，则到缓存中取出对应的 value 值，并验证 token 是否过期。验证通过后，通过 value 值解析出 userID 并执行相应的业务操作。下面拿创建地址来举例：</p> <br> <ul><li><p><strong>Controller层</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
* 更新或者创建用户收获地址
*/</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">createOrUpdateAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$validate</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddressNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$validate</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 token 获取 userID</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> TokenService<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拿到 userID 后完成后续业务逻辑</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <ul><li><p><strong>Service层</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 当需要获取全局UID时，应当调用此方法，而不应当自己解析UID
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'uid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$uid</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$token</span> <span class="token operator">=</span> Request<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$vars</span> <span class="token operator">=</span> Cache<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$vars</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里判断通过后直接返回了值，没有对 token 进行过期判断</span>
            <span class="token keyword">return</span> <span class="token variable">$vars</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'传入Token不合法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <br> <h3 id="用户身份权限控制"><a href="#用户身份权限控制" aria-hidden="true" class="header-anchor">#</a> 用户身份权限控制</h3> <p>这里我们自己实现了用户的权限控制，更成熟的权限体系可以了解 RBAC（基于角色的访问控制）。</p> <ul><li><strong>权限控制基类</strong></li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 接口访问权限枚举
 * 这种权限涉及是逐级式，虽然简单，但不够灵活
 * 最完整的权限控制方式是作用域列表式权限，给每个令牌划分到一个SCOPE作用域，每个作用域
 * 可访问多个接口
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ScopeEnum</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 普通用户权限</span>
    <span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token comment">// 管理员是给CMS准备的权限</span>
    <span class="token keyword">const</span> Super <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <ul><li><strong>权限颁发</strong></li></ul> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-php"><code><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">prepareCachedValue</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$cachedValue</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">;</span>
    <span class="token variable">$cachedValue</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'uid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$uid</span><span class="token punctuation">;</span>
    <span class="token variable">$cachedValue</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'scope'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ScopeEnum<span class="token punctuation">:</span><span class="token punctuation">:</span>User<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$cachedValue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>拿到微信服务器返回的数据后，在拼接上用户的 userID 以及用户的权限 scope，然后将拼接后的数据生成Token。</p> <br> <ul><li><strong>权限拦截封装</strong></li></ul> <div class="language-php extra-class"><pre class="language-php"><code>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">checkPrimaryScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$scope</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$scope</span> <span class="token operator">&gt;=</span> ScopeEnum<span class="token punctuation">:</span><span class="token punctuation">:</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <ul><li><p><strong>权限控制使用</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">checkPrimaryScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$scope</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$scope</span> <span class="token operator">&gt;=</span> ScopeEnum<span class="token punctuation">:</span><span class="token punctuation">:</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">// 权限不够</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有权限</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <br> <br> <h3 id="微信支付"><a href="#微信支付" aria-hidden="true" class="header-anchor">#</a> 微信支付</h3> <br> <br> <h3 id="订单系统"><a href="#订单系统" aria-hidden="true" class="header-anchor">#</a> 订单系统</h3> <p>用户选择商品后，向 API 提交包含所选商品的相关信息，API 接收到信息后，需要检查订单相关商品库存量（第一次检测库存）。如果有库存，把订单数据存入数据库中（下单成功），返回客户端消息，告诉客户端可以支付了。</p> <p>客户端调用支付接口进行支付，同时再次检测库存量（第二次检测库存）。通过后，服务端就可以调用微信支付接口进行支付，根据微信返回的结果判断是否支付成功。成功就再一次检测库存（第三次检测库存），并进行库存量的扣除，失败则返回一个支付失败的结果。</p> <p>小程序由于微信返回的支付结果是滞后的（异步），所以在进行小程序后端开发时，只处理订单支付成功的逻辑。具体业务流程如下图所示：</p> <p><img src="/blog/assets/img/kaifa_5.5687898b.png" alt></p> <br> <br> <h3 id="分页"><a href="#分页" aria-hidden="true" class="header-anchor">#</a> 分页</h3></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">7/7/2019, 9:55:38 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/app.39887082.js" defer></script><script src="/blog/assets/js/20.e68ded11.js" defer></script><script src="/blog/assets/js/66.a0b0e699.js" defer></script>
  </body>
</html>
